<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    td {width: 80px; height: 80px}
  </style>
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
  <script type="text/javascript" src="Game.js"></script>
  <script type="text/javascript">

  var fieldSize = 7;
  var board = defaultBoard(fieldSize);

  function renderCell(cell) {
    var res = cell.desc;
    if (cell.team)
      res = teams[cell.team] + " " + res;
    if (cell.money)
      res += ("<br/>" + "Бабло: " + cell.money);
    return res;
  }

  function renderPirate(pirate) {
    var res = pirate.desc + " " + pirate.id;
    if (pirate.money)
      res += " с баблом"
    return $("<div></div")
      .attr("id", "pirate" + pirate.id)
      .text(res)
      .click(function() {
        checkActions(pirate);
      });
  }

  function renderAction(who, action) {
    var res = $("<div></div>")
      .text(action.desc)
      .attr("class", "pirate" + who.id)
      //do action
      .click(function () {
        $(".pirate" + who.id).remove();
        var oldX = who.x, oldY = who.y;
        action.act(who, board);
        drawCell(oldX, oldY);
        drawCell(action.x, action.y);
      });
    return res;
  }

  function drawCell(i, j) {
    var cell = board.cell(i, j);
    var pos = i + "_" + j;
    var td = $("#" + pos);
    td.html(renderCell(cell)).attr("bgcolor", cell.color);
    for (var p of board.piratesOn(i, j)) {
      if (p.x == i && p.y == j)
        td.append(renderPirate(p));
    }
  }

  function checkActions(p) {
    $(function () {
      $(".pirate" + p.id).remove();
      for (var action of board.possibleActions(p)) {
        var pos = action.x + "_" + action.y;
        $("#" + pos).append(renderAction(p, action));
      }
    });
  }

  $(function() {
    var table = $("#board");
    for (var j = 0; j < fieldSize; ++j) {
      var row = $("<tr></tr>");
      for (var i = 0; i < fieldSize; ++i) {
        var pos = i + "_" + j;
        row.append($("<td></td>").attr("id", pos).text(pos));
      }
      table.append(row);
    }

    //Game init
    {
      var somePirate = makePirate(1, 3, 1);
      board.pirate(1, somePirate);
      drawCell(somePirate.x, somePirate.y);

      for (var i = 0; i < fieldSize; ++i) {
        drawCell(i, 0);
        drawCell(i, fieldSize - 1);
        drawCell(0, i);
        drawCell(fieldSize - 1, i);
      }
    }
  });
  </script>
</head>
<body>
  <table id="board" border="1"></table>
</body>
</html>
